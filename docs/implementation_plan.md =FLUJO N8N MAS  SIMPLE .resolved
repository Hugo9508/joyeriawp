# Workflow v8: Alma Dual-Channel + Smart Handoff + Google Sheets CRM

RefactorizaciÃ³n completa del flujo n8n para la JoyerÃ­a Alianza. El objetivo es simplificar el flujo de atenciÃ³n, eliminar duplicaciÃ³n de mensajes al vendedor, y agregar un CRM bÃ¡sico en Google Sheets.

## User Review Required

> [!IMPORTANT]
> **Credencial de Dify incorrecta:** El flujo actual (v7) posiblemente estÃ¡ llamando a una versiÃ³n vieja del agente. La credencial actual `Dify clientesuy26@gmail.com` (id: `oJqYFYdLcHE7q7pG`) debe actualizarse con la API Key `app-4ywbOMEo8yMuls03aWsDluhr` que corresponde a la Alma actualizada.

> [!WARNING]
> **Google Sheets:** Se necesita crear una hoja de cÃ¡lculo y compartirla con la cuenta de servicio de n8n. El usuario debe proporcionar el ID de la hoja y configurar la credencial de Google Sheets en n8n.

> [!CAUTION]
> **Prompt de Alma en Dify:** Se debe modificar directamente en la interfaz de Dify. El cambio incluye la instrucciÃ³n del marcador `[HANDOFF]` y la lectura del prefijo de canal `[Canal: Web]` / `[Canal: WhatsApp]`.

---

## Proposed Changes

### Componente 1: Credencial de Dify

#### [MODIFY] Credencial en n8n (manual)

- Ir a **n8n â†’ Credentials â†’ "Dify clientesuy26@gmail.com"**
- Cambiar el **API Key** a: `app-4ywbOMEo8yMuls03aWsDluhr`
- Guardar

Esto corrige el problema raÃ­z de las respuestas largas y con tablas: n8n estaba llamando a un agente desactualizado.

---

### Componente 2: Prompt de Alma en Dify

#### [MODIFY] Prompt del agente Alma (en Dify UI)

Agregar al final del prompt existente de Alma:

```text
## REGLAS DE CANAL
- Si el mensaje del cliente comienza con [Canal: WhatsApp], respondÃ© aÃºn mÃ¡s breve (2-3 lÃ­neas mÃ¡ximo).
- Si comienza con [Canal: Web Boutique], podÃ©s ser un poco mÃ¡s descriptiva (3-4 lÃ­neas).
- NUNCA menciones el canal al cliente.

## REGLA DE HANDOFF
Cuando detectes que el cliente muestra intenciÃ³n de compra real (pide precio final, forma de pago, quiere comprar, dice "me interesa", "lo quiero"), hacÃ© lo siguiente:
1. CerrÃ¡ con una frase cÃ¡lida agradeciendo la conversaciÃ³n
2. MencionÃ¡ que lo conectarÃ¡s con una asesora especializada
3. AgregÃ¡ el texto EXACTO [HANDOFF] al final de tu mensaje (es invisible para el cliente)

Ejemplo de respuesta con handoff:
"QuÃ© hermosa elecciÃ³n para un momento tan especial. Te voy a conectar con nuestra asesora Laura que te va a ayudar con todos los detalles del pedido. Â¡Tu compra estÃ¡ en las mejores manos! ğŸ’ [HANDOFF]"
```

---

### Componente 3: Google Sheets

#### [NEW] Hoja "Historial de Chat"

Columnas:
| timestamp | conversation_id | canal | sender | mensaje | phone |
|---|---|---|---|---|---|

- Cada mensaje (entrada y respuesta de Alma) se guarda como una fila
- Se usa para leer el historial al momento del handoff

#### [NEW] Hoja "Prospectos"

Columnas:
| fecha | canal | nombre | telefono | producto | para_quien | ocasion | urgencia | preferencias | nivel_interes | estado | conversation_id |
|---|---|---|---|---|---|---|---|---|---|---|---|

- Se llena SOLO cuando hay handoff
- El LLM Resumen extrae estos campos del historial

---

### Componente 4: Workflow n8n v8

#### [NEW] [n8n_flujo_v8_smart_handoff.json](file:///C:/Users/kript/OneDrive/Documentos/Antigravity01/joyeriawp/docs/n8n_flujo_v8_smart_handoff.json)

**Nodos del flujo (13 nodos):**

```mermaid
graph TD
    A[Webhook] --> B[Preparar Datos v8]
    B --> C[Router]
    C -->|seller_reply| D[Preparar Pausa]
    C -->|command| E[Procesar Comando]
    C -->|chat/WA| F[Consultar Handoff - Supabase]
    D --> D1[Guardar Pausa - Supabase]
    E --> E1[Guardar Estado - Supabase]
    F --> G{Â¿IA Activa?}
    G -->|NO| H[Resp: Vendedor Atendiendo]
    G -->|SÃ| I[ğŸ“Š Guardar Msg en Sheets]
    I --> J[ğŸ¤– Dify Alma]
    J --> K[Verificar Respuesta]
    K --> L{Â¿Tiene HANDOFF?}
    L -->|NO| M[Responder al Cliente]
    L -->|SÃ| N[ğŸ“– Leer Historial Sheets]
    N --> O[ğŸ§  LLM Resumen]
    O --> P[ğŸ“Š Guardar Prospecto en Sheets]
    P --> Q[ğŸ“± Enviar Resumen al Vendedor - WA]
    Q --> R[ğŸ’¾ Pausar IA - Supabase]
    R --> S[Responder al Cliente con Link WA]
```

**Cambios clave vs v7:**

| Nodo | v7 | v8 |
|---|---|---|
| `Preparar Datos` | No inyecta canal | Inyecta `[Canal: Web]` o `[Canal: WhatsApp]` en el texto |
| `ğŸ“¤ Notificar Vendedor` | EnvÃ­a cada mensaje al vendedor | **ELIMINADO** |
| `âœ¨ Formatear Respuesta` (LLM) | GPT-4.1-mini en cada mensaje | **ELIMINADO** |
| `ğŸ“Š Guardar Msg en Sheets` | No existÃ­a | **NUEVO** â€” graba cada mensaje |
| `Â¿Tiene [HANDOFF]?` | No existÃ­a | **NUEVO** â€” IF node detecta marcador |
| `ğŸ“– Leer Historial Sheets` | No existÃ­a | **NUEVO** â€” lee filas por conversation_id |
| `ğŸ§  LLM Resumen` | No existÃ­a | **NUEVO** â€” GPT-4.1-mini extrae datos (solo en handoff) |
| `ğŸ“Š Guardar Prospecto` | No existÃ­a | **NUEVO** â€” fila en hoja Prospectos |
| `ğŸ“± Enviar Resumen` | Enviaba chat crudo | **NUEVO** â€” envÃ­a resumen estructurado |

---

#### Detalle del nodo: `Preparar Datos v8` (Code)

```javascript
// Cambio clave: inyectar canal en el texto
const canal = body.event === 'messages.upsert' ? 'WhatsApp' : 'Web Boutique';
const textWithChannel = `[Canal: ${canal}] ${text}`;

return {
  json: {
    // ... campos existentes ...
    text: textWithChannel,
    originalText: text,
    canal: canal
  }
};
```

#### Detalle del nodo: `Â¿Tiene [HANDOFF]?` (IF)

```
CondiciÃ³n: {{ $json.answer }} contiene "[HANDOFF]"
  TRUE â†’ Flujo de handoff
  FALSE â†’ Responder al cliente
```

AdemÃ¡s, limpiar el marcador antes de enviar al cliente:
```javascript
// En el nodo de respuesta
const cleanAnswer = $json.answer.replace('[HANDOFF]', '').trim();
```

#### Detalle del nodo: `ğŸ§  LLM Resumen` (GPT-4.1-mini)

Prompt:
```text
Analiza este historial de chat entre un cliente y la asesora Alma de JoyerÃ­a Alianza.
Extrae la siguiente informaciÃ³n en formato JSON:

{
  "nombre": "nombre del cliente",
  "producto": "producto de interÃ©s",
  "para_quien": "para quiÃ©n es",
  "ocasion": "ocasiÃ³n o motivo",
  "urgencia": "nivel de urgencia",
  "preferencias": "metal, talla, estilo",
  "nivel_interes": "bajo/medio/alto",
  "resumen": "resumen en 2 lÃ­neas para el vendedor"
}

Si algÃºn campo no se mencionÃ³, ponÃ© "No especificado".
Historial:
{{ historial_from_sheets }}
```

#### Detalle del nodo: `ğŸ“± Enviar Resumen al Vendedor`

Mensaje para Evolution API:
```text
ğŸ›ï¸ Prospecto calificado desde {{ canal }}

ğŸ‘¤ {{ nombre }} ({{ telefono }})
ğŸ’ {{ producto }}
ğŸ {{ para_quien }} - {{ ocasion }}
â° {{ urgencia }}
âœ¨ {{ preferencias }}
ğŸ”¥ InterÃ©s: {{ nivel_interes }}

ğŸ“ {{ resumen }}
```

---

## Verification Plan

### Test Manual en n8n (con Pinned Data)

**Test 1: Mensaje normal de Web Chat (sin handoff)**
1. En n8n, usar el Pinned Data existente del webhook
2. Ejecutar el workflow
3. Verificar:
   - âœ… El mensaje se graba en Google Sheets (hoja Historial)
   - âœ… Dify recibe el texto con prefijo `[Canal: Web Boutique]`
   - âœ… La respuesta de Alma NO tiene `[HANDOFF]`
   - âœ… La respuesta llega al respondToWebhook sin pasar por LLM Resumen
   - âŒ NO se envÃ­a mensaje al vendedor por WhatsApp

**Test 2: Mensaje que activa handoff**
1. Simular un mensaje como: `"SÃ­, me interesa, Â¿cÃ³mo puedo pagar?"`
2. Verificar:
   - âœ… La respuesta de Alma contiene `[HANDOFF]`
   - âœ… Se lee el historial de Sheets
   - âœ… El LLM genera un JSON con datos del prospecto
   - âœ… Se graba en hoja Prospectos
   - âœ… El vendedor recibe UN mensaje limpio en WhatsApp
   - âœ… Se pausa la IA en Supabase
   - âœ… El cliente recibe respuesta con link de WhatsApp
   - âœ… El marcador `[HANDOFF]` NO aparece en la respuesta al cliente

**Test 3: Mensaje de WhatsApp entrante**
1. Simular un evento `messages.upsert` de Evolution API
2. Verificar:
   - âœ… Canal detectado como WhatsApp
   - âœ… Dify recibe `[Canal: WhatsApp]`
   - âœ… Respuesta se envÃ­a por Evolution API (no por respondToWebhook)

**Test 4: Vendedor responde (#pausa)**
1. Simular seller_reply
2. Verificar:
   - âœ… IA se pausa en Supabase por 30 min
   - âœ… Mensajes posteriores notifican al vendedor que hay mensaje pendiente
