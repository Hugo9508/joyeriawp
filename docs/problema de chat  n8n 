Ahora tengo todo lo que necesito. El problema es claro:

```typescript
socketRef.current = io(appSettings.siteUrl); // ‚ùå Socket.io no funciona en Hostinger/Next.js
```

Voy a reemplazar Socket.io por **polling** directamente en el ChatWidget, m√°s los 2 archivos de soporte. Son **3 archivos** para crear/modificar:

---

### Archivo 1 ‚Äî CREAR: `src/lib/messageStore.ts`

```typescript
// src/lib/messageStore.ts
type Message = {
  id: string;
  text: string;
  senderName: string;
  phoneNumber: string;
  conversation_id?: string;
  timestamp: number;
};

const globalStore = global as typeof global & {
  pendingMessages?: Map<string, Message[]>;
};

if (!globalStore.pendingMessages) {
  globalStore.pendingMessages = new Map();
}

export const messageStore = {
  add(msg: Omit<Message, 'id' | 'timestamp'>): void {
    const store = globalStore.pendingMessages!;
    const msgs = store.get(msg.phoneNumber) || [];
    msgs.push({ ...msg, id: Math.random().toString(36).slice(2), timestamp: Date.now() });
    if (msgs.length > 50) msgs.shift();
    store.set(msg.phoneNumber, msgs);
  },

  consume(phoneNumber: string): Message[] {
    const store = globalStore.pendingMessages!;
    const msgs = store.get(phoneNumber) || [];
    store.delete(phoneNumber);
    return msgs;
  },
};
```

---

### Archivo 2 ‚Äî MODIFICAR: `src/app/api/webhook/route.ts`

```typescript
// src/app/api/webhook/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { messageStore } from '@/lib/messageStore';

export const runtime = 'nodejs';

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    console.log(`[WEBHOOK] type=${body.type} | from=${body.senderName} | phone=${body.phoneNumber}`);

    const { text, senderName, phoneNumber, conversation_id } = body;

    if (!text || !phoneNumber) {
      return NextResponse.json({ error: 'Faltan campos: text y phoneNumber' }, { status: 400 });
    }

    messageStore.add({ text, senderName: senderName || 'Luna IA', phoneNumber, conversation_id });

    return NextResponse.json({ received: true, at: new Date().toISOString() });
  } catch (error: any) {
    console.error('[WEBHOOK_ERROR]', error.message);
    return NextResponse.json({ error: 'Payload malformado' }, { status: 400 });
  }
}

export async function GET() {
  return NextResponse.json({ status: 'online', service: 'Alianza Chat Webhook' });
}
```

---

### Archivo 3 ‚Äî CREAR: `src/app/api/messages/route.ts`

```typescript
// src/app/api/messages/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { messageStore } from '@/lib/messageStore';

export const runtime = 'nodejs';

export async function GET(req: NextRequest) {
  const phone = new URL(req.url).searchParams.get('phone');
  if (!phone) {
    return NextResponse.json({ error: 'Par√°metro phone requerido' }, { status: 400 });
  }
  const messages = messageStore.consume(phone);
  return NextResponse.json({ messages, count: messages.length });
}
```

---

### Archivo 4 ‚Äî MODIFICAR: `src/components/chat-widget.tsx`

Solo cambian **2 secciones** del archivo existente. Reemplaza el bloque del `useEffect` inicial y elimina el import de socket.io:

**Quita este import:**
```typescript
import { io, Socket } from 'socket.io-client'; // ‚ùå ELIMINAR
```

**Reemplaza el primer `useEffect` completo** (el que tiene `socketRef.current = io(...)`) por este:

```typescript
useEffect(() => {
  const saved = localStorage.getItem('alianza_user_info');
  if (saved) setUserInfo(JSON.parse(saved));

  const handleOpenWithMsg = (e: any) => {
    setIsOpen(true);
    const msg = e.detail?.message;
    if (!localStorage.getItem('alianza_user_info')) {
      setPendingText(msg);
      setShowOnboarding(true);
    } else if (msg) {
      processMessage(msg);
    }
  };

  const handleOpenOnly = () => {
    setIsOpen(true);
    if (!localStorage.getItem('alianza_user_info')) setShowOnboarding(true);
  };

  window.addEventListener('open-chat-with-message', handleOpenWithMsg);
  window.addEventListener('open-chat-only', handleOpenOnly);

  return () => {
    window.removeEventListener('open-chat-with-message', handleOpenWithMsg);
    window.removeEventListener('open-chat-only', handleOpenOnly);
  };
}, []);
```

**Agrega este nuevo `useEffect` de polling** justo despu√©s del anterior:

```typescript
// Polling ‚Äî recibe respuestas del bot cada 2.5s
useEffect(() => {
  if (!userInfo?.phone) return;

  const interval = setInterval(async () => {
    try {
      const res = await fetch(`/api/messages?phone=${userInfo.phone}`);
      const data = await res.json();
      if (data.messages?.length > 0) {
        data.messages.forEach((msg: { id: string; text: string; senderName: string; timestamp: number }) => {
          setMessages(prev => {
            // Evitar duplicados
            if (prev.some(m => m.id === msg.id)) return prev;
            return [...prev, {
              id: msg.id,
              text: msg.text,
              sender: 'agent' as const,
              timestamp: new Date(msg.timestamp),
            }];
          });
        });
      }
    } catch (err) {
      // Silencioso ‚Äî no interrumpir UX por errores de polling
    }
  }, 2500);

  return () => clearInterval(interval);
}, [userInfo?.phone]);
```

**Y elimina la ref de socket** que ya no se usa:
```typescript
const socketRef = useRef<Socket | null>(null); // ‚ùå ELIMINAR esta l√≠nea
```

---

### Resumen del flujo final

```
Usuario escribe ‚Üí sendMessageAction ‚Üí n8n ‚Üí Dify Luna
                                               ‚Üì
                              POST /api/webhook ‚Üí messageStore.add()
                                               ‚Üì
Chat polling GET /api/messages?phone=xxx ‚Üê‚îÄ‚îÄ cada 2.5s
                    ‚Üì
         setMessages() ‚Üí aparece en pantalla ‚úÖ
```

El `phoneNumber` que n8n env√≠a en el POST debe coincidir exactamente con el que el usuario ingres√≥ en el onboarding. Verifica en n8n que el nodo `üì® Enviar Respuesta al Chat` env√≠e el n√∫mero **sin prefijo 598** si el usuario lo ingres√≥ as√≠, o con prefijo si lo ingres√≥ completo. El campo clave es `phoneNumber` en ambos lados.